<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Checker (No Freeze Version)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        
        textarea { width: 100%; height: 150px; padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; }
        
        .btn-area { text-align: center; margin: 20px 0; }
        button {
            padding: 12px 25px; font-size: 18px; font-weight: bold; cursor: pointer;
            color: white; border: none; border-radius: 5px; transition: 0.3s;
        }
        #btnCheck { background-color: #007bff; }
        #btnCheck:hover { background-color: #0056b3; }
        #btnReset { background-color: #dc3545; margin-left: 10px; }

        /* Output Box */
        #output { 
            min-height: 150px; padding: 15px; border: 2px solid #ddd; 
            border-radius: 4px; background: #fff; line-height: 1.6; font-size: 16px;
            white-space: pre-wrap;
        }

        /* Status Text */
        #status { text-align: center; margin-bottom: 10px; font-weight: bold; color: #666; height: 20px; }

        /* Highlight Styles */
        .err { 
            border-bottom: 3px solid; 
            cursor: pointer; 
            position: relative; 
            display: inline-block;
        }
        .err:hover::after {
            content: attr(data-fix);
            position: absolute;
            background: #333; color: #fff; padding: 5px 10px;
            border-radius: 5px; font-size: 14px;
            bottom: 100%; left: 50%; transform: translateX(-50%);
            white-space: nowrap; z-index: 10;
        }

        /* Colors */
        .c-red { border-color: red; background: #ffebeb; color: red; }
        .c-green { border-color: green; background: #e8f5e9; color: green; }
        .c-orange { border-color: orange; background: #fff3e0; color: #d84315; }
        .c-blue { border-color: blue; background: #e3f2fd; color: #1565c0; }

    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Grammar Checker (Anti-Freeze)</h1>
    
    <p style="font-weight:bold">Input Text:</p>
    <textarea id="inp">He have a car. I did went to school. Teh weather is good .</textarea>

    <div class="btn-area">
        <button id="btnCheck" onclick="safeCheck()">üîç CHECK NOW</button>
        <button id="btnReset" onclick="location.reload()">üîÑ RESET</button>
    </div>

    <div id="status">Ready</div>

    <p style="font-weight:bold">Result:</p>
    <div id="output"></div>
</div>

<script>
    // ----------------------------------------------------
    // 1. RULES DATABASE
    // ----------------------------------------------------
    const rules = [
        // SPELLING (Red)
        { regex: /teh/gi, fix: "the", type: "c-red" },
        { regex: /recieve/gi, fix: "receive", type: "c-red" },
        { regex: /tommorow/gi, fix: "tomorrow", type: "c-red" },
        { regex: /untill/gi, fix: "until", type: "c-red" },

        // GRAMMAR (Green)
        { regex: /\b(he|she|it|John)\s+(have)\b/gi, fix: "has", type: "c-green" },
        { regex: /\b(I|You|We|They)\s+(has)\b/gi, fix: "have", type: "c-green" },
        { regex: /\b(did|didn't)\s+(went|saw|ate|came)\b/gi, fix: "did + verb1", type: "c-green" },
        { regex: /\b(to)\s+(went|goes)\b/gi, fix: "to go", type: "c-green" },

        // ARTICLES (Orange)
        { regex: /\b(a)\s+(apple|elephant|ice|orange|umbrella)\b/gi, fix: "an", type: "c-orange" },
        { regex: /\b(an)\s+(car|book|house|dog)\b/gi, fix: "a", type: "c-orange" },

        // PUNCTUATION (Blue)
        { regex: /\s+([.,?!])/g, fix: "$1", type: "c-blue" },
        { regex: /,([^ \n])/g, fix: ", $1", type: "c-blue" }
    ];

    // ----------------------------------------------------
    // 2. MAIN FUNCTION (With Safety Brake)
    // ----------------------------------------------------
    function safeCheck() {
        const btn = document.getElementById('btnCheck');
        const status = document.getElementById('status');
        const input = document.getElementById('inp');
        const output = document.getElementById('output');
        
        // 1. Update UI immediately
        btn.innerText = "Processing...";
        status.innerText = "Working...";
        status.style.color = "orange";

        // 2. Use setTimeout to allow UI to update before heavy lifting
        setTimeout(() => {
            try {
                const text = input.value;
                if (!text.trim()) {
                    output.innerHTML = "Please type something.";
                    resetUI();
                    return;
                }

                let findings = [];

                // --- LOOP RULES ---
                for (let i = 0; i < rules.length; i++) {
                    const rule = rules[i];
                    const re = new RegExp(rule.regex);
                    let match;
                    
                    // *** SAFETY BRAKE ***
                    // ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏•‡∏π‡∏õ‡∏ô‡∏£‡∏Å ‡∏ñ‡πâ‡∏≤‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 200 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠ 1 ‡∏Å‡∏é ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    let loopCount = 0; 
                    const MAX_LOOP = 200; 

                    while ((match = re.exec(text)) !== null) {
                        loopCount++;
                        if (loopCount > MAX_LOOP) {
                            console.warn("Safety Brake Activated for rule:", rule);
                            break; // Force stop this rule
                        }

                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Suggestion
                        let suggestion = rule.fix;
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡πÜ (‡πÑ‡∏°‡πà‡∏°‡∏µ $1) ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏£‡∏á‡πÜ
                        
                        findings.push({
                            start: match.index,
                            end: match.index + match[0].length,
                            word: match[0],
                            suggest: suggestion,
                            type: rule.type
                        });

                        // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ñ‡πâ‡∏≤ Match ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á) ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö Index ‡πÄ‡∏™‡∏°‡∏≠
                        if (match.index === re.lastIndex) {
                            re.lastIndex++;
                        }
                    }
                }

                // --- BUILD HTML ---
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á
                findings.sort((a, b) => a.start - b.start);

                let html = "";
                let cursor = 0;

                for (let j = 0; j < findings.length; j++) {
                    const item = findings[j];
                    
                    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô (Overlap)
                    if (item.start < cursor) continue;

                    // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    html += escapeHtml(text.substring(cursor, item.start));

                    // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Highlight
                    html += `<span class="err ${item.type}" data-fix="‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô: ${item.suggest}">
                                ${escapeHtml(item.word)}
                             </span>`;

                    cursor = item.end;
                }

                // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                html += escapeHtml(text.substring(cursor));

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                output.innerHTML = html;
                status.innerText = "Done! (‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)";
                status.style.color = "green";

            } catch (err) {
                console.error(err);
                output.innerHTML = "<span style='color:red'>Error: " + err.message + "</span>";
                status.innerText = "System Error";
                status.style.color = "red";
            } finally {
                resetUI();
            }
        }, 100); // Delay 100ms
    }

    function resetUI() {
        document.getElementById('btnCheck').innerText = "üîç CHECK NOW";
    }

    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Grammar Checker (No Freeze)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #ea580c;
        }

        body { font-family: 'Sarabun', sans-serif; background: var(--bg-color); padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); }
        
        .controls { text-align: center; margin: 20px 0; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; margin: 5px; }
        .btn-check { background: var(--primary); }
        .btn-check:hover { background: #1d4ed8; }
        .btn-reset { background: #64748b; }
        .btn-print { background: var(--success); }

        .editor-box { display: flex; gap: 20px; flex-wrap: wrap; }
        .box { flex: 1; min-width: 300px; }
        textarea, .result-area { 
            width: 100%; height: 350px; padding: 15px; 
            border: 2px solid #e2e8f0; border-radius: 8px; 
            font-family: 'Courier Prime', monospace; font-size: 16px; 
            resize: vertical; box-sizing: border-box; line-height: 1.6;
        }
        .result-area { background: white; overflow-y: auto; white-space: pre-wrap; }

        /* Highlight Styles */
        .err { 
            border-bottom: 2px solid; 
            cursor: pointer; 
            position: relative; 
            padding: 2px 0;
        }
        .err-red { border-color: var(--danger); background: #fef2f2; color: var(--danger); }
        .err-green { border-color: var(--success); background: #f0fdf4; color: var(--success); }
        .err-orange { border-color: var(--warning); background: #fff7ed; color: var(--warning); }

        /* Tooltip */
        .err:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 130%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 5px 10px;
            border-radius: 4px; font-size: 14px; white-space: nowrap; z-index: 10;
            pointer-events: none;
        }

        /* Loading Spinner */
        #loading { display: none; color: var(--primary); font-weight: bold; margin-top: 10px; }

        @media print {
            .controls, textarea, h1 { display: none; }
            .container { box-shadow: none; border: none; padding: 0; width: 100%; }
            .result-area { border: none; height: auto; font-size: 14pt; }
            .err { border: none; text-decoration: underline; color: black !important; background: none !important; }
            .err::after {
                content: " [" attr(data-clean) "] ";
                position: static; font-size: 0.8em; color: #555; transform: none; display: inline; border: 1px solid #ccc; padding: 0 4px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üõ°Ô∏è Stable Grammar Checker</h1>
    
    <div class="controls">
        <button class="btn-reset" onclick="loadSample()">Load Sample</button>
        <button class="btn-check" onclick="startCheck()">üîç Check Now</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è Print</button>
        <div id="loading">Processing...</div>
    </div>

    <div class="editor-box">
        <div class="box">
            <label><strong>Input:</strong></label>
            <textarea id="inputText" placeholder="Paste text here..."></textarea>
        </div>
        <div class="box">
            <label><strong>Result:</strong></label>
            <div id="resultText" class="result-area"></div>
        </div>
    </div>
</div>

<script>
    // --- 1. ‡∏Å‡∏é (Rules) ---
    // ‡πÉ‡∏ä‡πâ string pattern ‡πÅ‡∏ó‡∏ô RegExp object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏ï‡∏≠‡∏ô clone
    const rules = [
        // SPELLING (Red)
        { id: 'spell', pattern: "\\b(teh)\\b", flags: "gi", suggest: "the", type: "red" },
        { id: 'spell', pattern: "\\b(recieve)\\b", flags: "gi", suggest: "receive", type: "red" },
        { id: 'spell', pattern: "\\b(tommorow)\\b", flags: "gi", suggest: "tomorrow", type: "red" },
        { id: 'spell', pattern: "\\b(definately)\\b", flags: "gi", suggest: "definitely", type: "red" },
        { id: 'spell', pattern: "\\b(untill)\\b", flags: "gi", suggest: "until", type: "red" },
        
        // ARTICLES (Orange)
        { id: 'art', pattern: "\\b(a)\\s+(apple|elephant|ice|orange|umbrella|hour)\\b", flags: "gi", suggest: "an $2", type: "orange" },
        { id: 'art', pattern: "\\b(an)\\s+(car|book|house|university|year)\\b", flags: "gi", suggest: "a $2", type: "orange" },

        // GRAMMAR (Green)
        { id: 'gram', pattern: "\\b(he|she|it)\\s+(have|don't)\\b", flags: "gi", suggest: "has/doesn't", type: "green" },
        { id: 'gram', pattern: "\\b(I)\\s+(has)\\b", flags: "gi", suggest: "have", type: "green" },
        { id: 'gram', pattern: "\\b(did|didn't)\\s+(went|saw|ate|came)\\b", flags: "gi", suggest: "did + verb1", type: "green" },
        { id: 'gram', pattern: "\\b(to)\\s+(went|goes|gone)\\b", flags: "gi", suggest: "to go", type: "green" },
        { id: 'gram', pattern: "\\b(will|can)\\s+(to)\\b", flags: "gi", suggest: "remove 'to'", type: "green" },

        // PUNCTUATION (Blue/Red) - ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ß‡∏±‡∏á Infinite Loop
        { id: 'punct', pattern: "\\s+([.,?!])", flags: "g", suggest: "$1 (No space before)", type: "red" },
        { id: 'punct', pattern: ",([^\\s])", flags: "g", suggest: ", $1", type: "red" }
    ];

    function loadSample() {
        document.getElementById('inputText').value = "He have a apple. I did went to school tommorow . Please recieve this,thanks.";
    }

    function startCheck() {
        const input = document.getElementById('inputText').value;
        const outputDiv = document.getElementById('resultText');
        const loading = document.getElementById('loading');

        if (!input) return;

        // ‡πÅ‡∏™‡∏î‡∏á Loading ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ô‡∏≤‡∏ô
        loading.style.display = 'block';
        outputDiv.innerHTML = '';

        setTimeout(() => {
            try {
                const html = processText(input);
                outputDiv.innerHTML = html;
            } catch (e) {
                console.error(e);
                outputDiv.innerHTML = "<span style='color:red'>Error processing text. Please try again.</span>";
            }
            loading.style.display = 'none';
        }, 50);
    }

    function processText(text) {
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        let matches = [];

        rules.forEach(rule => {
            try {
                const regex = new RegExp(rule.pattern, rule.flags);
                let match;
                
                // SAFETY LOOP: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Infinite Loop
                let loopLimit = 1000; 
                let loopCount = 0;

                while ((match = regex.exec(text)) !== null) {
                    loopCount++;
                    if (loopCount > loopLimit) break; // Break ‡∏ñ‡πâ‡∏≤‡∏ß‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Suggestion (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö $1, $2 replacement)
                    let suggestion = rule.suggest;
                    if (suggestion.includes('$')) {
                        // ‡πÉ‡∏ä‡πâ trick ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠ replace group
                        suggestion = match[0].replace(regex, rule.suggest);
                    }

                    matches.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        text: match[0],
                        suggestion: suggestion,
                        type: rule.type
                    });

                    // SAFETY: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ Match ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (Zero-length) ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö index
                    if (match.index === regex.lastIndex) {
                        regex.lastIndex++;
                    }
                }
            } catch (err) {
                console.warn("Rule Error:", rule, err);
            }
        });

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å
        matches.sort((a, b) => a.start - b.start);

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÇ‡∏î‡∏¢‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏°‡∏≤‡πÅ‡∏õ‡∏∞ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Overlap)
        let finalHtml = "";
        let lastCursor = 0;

        matches.forEach(m => {
            // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏° (Simple overlap protection)
            if (m.start < lastCursor) return;

            // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î
            finalHtml += escapeHtml(text.substring(lastCursor, m.start));

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Tag ‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î
            finalHtml += `<span class="err err-${m.type}" 
                            data-tip="‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô: ${m.suggestion}"
                            data-clean="${m.suggestion}">
                            ${escapeHtml(m.text)}
                          </span>`;

            lastCursor = m.end;
        });

        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        finalHtml += escapeHtml(text.substring(lastCursor));

        return finalHtml;
    }

    function escapeHtml(text) {
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>

</body>
</html>
